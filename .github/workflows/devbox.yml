---
name: devbox
on:
  pull_request:
    branches: [main, master]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  make:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - update
          - upgrade
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5

      - name: Run make ${{matrix.target}}
        uses: ./
        with:
          checkout: false
          run: "make ${{matrix.target}}"

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5

      - name: Run make test
        uses: ./
        with:
          checkout: false
          run: "make test"

      - name: Run make requirements
        uses: ./
        with:
          checkout: false
          run: "make requirements"
          path: tests/collection

      - name: Run make reset
        uses: ./
        with:
          checkout: false
          install: false
          run: "make reset"

      - name: Run make ${{matrix.target}}
        uses: ./
        with:
          checkout: false
          install: false
          run: "make install build"
          path: tests/collection

  devbox:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - lint
          - requirements
          - test
          - init
    env:
      GIT_BRANCH: ${{ github.head_ref || github.ref_name }}
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5

      - name: Run make ${{matrix.target}}
        uses: ./
        with:
          checkout: false
          pre: "make test"
          run: "make install ${{matrix.target}}"
          path: tests/collection

  version:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5

      - name: Run make ${{matrix.target}}
        uses: ./
        with:
          checkout: false
          run: "make install check_version BASE_SHA=${{ github.event.pull_request.base.sha }} HEAD_SHA=${{ github.event.pull_request.head.sha }}"
          path: tests/collection
